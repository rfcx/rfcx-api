on:
  workflow_call:
    inputs:
      runs-on:
        description: Platform to execute on
        type: string
        # default: deployment-runner
        default: ubuntu-latest
        required: false
      tag: 
        description: Image tag to deploy
        type: string
        required: true
      namespace:
        description: Kubernetes namespace
        type: string
        required: true
      aws-account-id:
        description: AWS account id
        type: string
        required: false
      aws-region:
        description: AWS region
        type: string
        required: false
        default: eu-west-1
    secrets:
      aws-access-key-id:
        description: AWS Access Key ID
        required: true
      aws-secret-access-key:
        description: AWS Secret Access Key
        required: true
jobs:
  build:
    runs-on: ${{ inputs.runs-on }}
    steps:

      - name: 'Setup: Configure AWS credentials'
        # v4 (4.0.0) @ Sep 2023 https://github.com/aws-actions/configure-aws-credentials/tags
        uses: aws-actions/configure-aws-credentials@8c3f20df09ac63af7b3ae3d7c91f105f857d8497
        with:
          aws-region: ${{ inputs.aws-region }}

      # TODO: get cluster name from inputs
      - name: 'Get Kubeconf EKS'
        run: |          
          aws eks update-kubeconfig --region ${{ inputs.aws-region }} --name ${{ vars.EKS_CLUSTER_NAME_NONPROD }}

      - name: 'Setup: Git checkout'
        # v4 (4.1.0) @ Sep 2022 https://github.com/actions/checkout/tags
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: 'Deploy: Set image version'
        run: |
          find build -name "*.yaml" -exec sed -i s/:latest/:${{ inputs.tag }}/g {} +
          find build -name "*.yaml" -exec sed -i s/aws-account-id/${{ inputs.aws-account-id }}/g {} +
          find build -name "*.yaml" -exec sed -i s/aws-region/${{ inputs.aws-region }}/g {} +

      - name: 'Deploy: Kubernetes apply'
        run: |
          kubectl delete -R -f build/${{ inputs.namespace }} --ignore-not-found=true -n ${{ inputs.namespace }} --grace-period=10
          kubectl apply -R -f build/${{ inputs.namespace }} -n ${{ inputs.namespace }}

#      - name: 'Deploy: Kubernetes verify core-api'
#        # v1 (1.21.2) @ 03 Nov 2021 https://github.com/actions-hub/kubectl/tags
#        uses: actions-hub/kubectl@365773786ebd92c7b36b6ab80e17d4a213ab0cd1
#        env:
#          KUBE_CONFIG: ${{ KUBE_CONFIG }} #${{ secrets.kube-config1 }}
#        with:
#          args: rollout status deployment/core-api --namespace=${{ inputs.namespace }}
#
#      - name: 'Deploy: Kubernetes verify core-tasks'
#        # v1 (1.21.2) @ 03 Nov 2021 https://github.com/actions-hub/kubectl/tags
#        uses: actions-hub/kubectl@365773786ebd92c7b36b6ab80e17d4a213ab0cd1
#        env:
#          KUBE_CONFIG: ${{ KUBE_CONFIG }} #${{ secrets.kube-config1 }}
#        with:
#          args: rollout status deployment/core-tasks --namespace=${{ inputs.namespace }}
#
#      - name: 'Deploy: Kubernetes verify media-api'
#        if: ${{ inputs.namespace == 'production' }}
#        # v1 (1.21.2) @ 03 Nov 2021 https://github.com/actions-hub/kubectl/tags
#        uses: actions-hub/kubectl@365773786ebd92c7b36b6ab80e17d4a213ab0cd1
#        env:
#          KUBE_CONFIG: ${{ KUBE_CONFIG }} #${{ secrets.kube-config1 }}
#        with:
#          args: rollout status deployment/media-api --namespace=${{ inputs.namespace }}
#
#      - name: 'Deploy: Kubernetes verify noncore-api'
#        # v1 (1.21.2) @ 03 Nov 2021 https://github.com/actions-hub/kubectl/tags
#        uses: actions-hub/kubectl@365773786ebd92c7b36b6ab80e17d4a213ab0cd1
#        env:
#          KUBE_CONFIG: ${{ KUBE_CONFIG }} #${{ secrets.kube-config1 }}
#        with:
#          args: rollout status deployment/noncore-api --namespace=${{ inputs.namespace }}
#
#      - name: 'Deploy: Kubernetes verify noncore-mqtt'
#        # v1 (1.21.2) @ 03 Nov 2021 https://github.com/actions-hub/kubectl/tags
#        uses: actions-hub/kubectl@365773786ebd92c7b36b6ab80e17d4a213ab0cd1
#        env:
#          KUBE_CONFIG: ${{ KUBE_CONFIG }} #${{ secrets.kube-config1 }}
#        with:
#          args: rollout status deployment/noncore-mqtt --namespace=${{ inputs.namespace }}
