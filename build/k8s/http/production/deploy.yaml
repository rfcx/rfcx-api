apiVersion: apps/v1
kind: Deployment
metadata:
  name: api
  namespace: production
spec:
  selector:
    matchLabels:
      app: api
  template:
    metadata:
      labels:
        app: api
    spec:
      containers:
      - name: api
        image: 887044485231.dkr.ecr.eu-west-1.amazonaws.com/api_production:latest
        envFrom:
        - secretRef:
            name: api-secrets
        env:
          - name: NEW_RELIC_APP_NAME
            value: "Core API"
          - name: NEW_RELIC_NO_CONFIG_FILE
            value: "true"
          - name: MAILCHIMP_API_URL
            value: "https://us9.api.mailchimp.com/3.0/"
          - name: NEW_RELIC_LOG_LEVEL
            value: "warning"
          - name: DB_PORT
            value: "3306"
          - name: ASSET_URLBASE
            value: "https://assets.rfcx.org"
          - name: HOME
            value: "/tmp"
          - name: CONSOLE_BASE_URL
            value: "https://console.rfcx.org/#/"
          - name: PORT
            value: "8081"
          - name: NODE_ENV
            value: "production"
          - name: SQS_PERCEPTION_BATCH
            value: "rfcx-perception-batch"
          - name: NODE_LOG_LEVEL
            value: "info"
          - name: PREDICTION_SERVICE_ENABLED
            value: "true"
          - name: AUTH0_DOMAIN
            value: "rfcx.eu.auth0.com"
          - name: AUTH0_CUSTOM_DOMAIN
            value: "auth.rfcx.org"
          - name: FFMPEG_PATH
            value: "/usr/bin/ffmpeg"
          - name: ASSET_BUCKET_AUDIO
            value: "rfcx-ark"
          - name: CLOUDWATCH_ENABLED
            value: "true"
          - name: NODE_HOME
            value: "/opt/elasticbeanstalk/node-install/node-v6.10.0-linux-x64"
          - name: WEBSOCKET_URL
            value: "https://prometheus-yggdrasil.rfcx.org"
          - name: CLOUDWATCH_LOGS_GROUP_NAME
            value: "rfcx-api-production"
          - name: ASSET_BUCKET_META
            value: "rfcx-guardian-meta-production"
          - name: DASHBOARD_BASE_URL
            value: "https://dashboard.rfcx.org/#/"
          - name: CACHE_DIRECTORY
            value: "/tmp/rfcx-api/"
          - name: SOX_PATH
            value: "/usr/bin/sox"
          - name: ASSET_BUCKET_ZIP
            value: "rfcx-zip"
          - name: AWS_QUEUE_CONCURRENCY
            value: "1000"
          - name: SEQUELIZE_VERBOSE
            value: "false"
          - name: EB_NODE_COMMAND
            value: "npm start"
          - name: BUCKET_ANALYSIS
            value: "rfcx-analysis"
          - name: BUCKET_PERCEPTION
            value: "rfcx-perception"
          - name: IMAGEMAGICK_PATH
            value: "/usr/bin/convert"
          - name: FIREBASE_ENABLED
            value: "true"
          - name: REST_PROTOCOL
            value: "https"
          - name: REST_HOST
            value: "api.rfcx.org"
          - name: REST_HOST_SHORT
            value: "rf.cx"
          - name: ASSET_BUCKET_REPORT
            value: "rfcx-report-production"
          - name: PNGCRUSH_PATH
            value: "/usr/bin/pngcrush"
          - name: NEO4J_ENABLED
            value: "true"
          - name: ASSET_BUCKET_ATTACHMENT
            value: "rfcx-attachment-production"
          - name: ASSET_BUCKET_AI
            value: "rfcx-ai-dev"
          - name: INGEST_BUCKET
            value: "rfcx-streams-production"
          - name: STREAMS_CACHE_BUCKET
            value: "rfcx-streams-cache-production"
          - name: USERS_BUCKET
            value: "rfcx-users-production"
          - name: MQTT_BROKER_HOST
            value: "mosquitto-service"
          - name: MEDIA_API_BASE_URL
            value: "https://media-api.rfcx.org/"
          - name: INGEST_SERVICE_BASE_URL
            value: "http://ingest-service-service/"
          - name: INGEST_SERVICE_ENABLED
            value: "true"
          - name: GUARDIAN_BROKER_HOSTNAME
            value: "api-mqtt.rfcx.org"
          - name: GUARDIAN_API_SMS_ADDRESS
            value: "+13467870964"
          - name: REDIS_ENABLED
            value: "true"
          - name: EARTHRANGER_ENABLED
            value: "true"
          - name: EARTHRANGER_BASE_URL
            value: "https://osaconservation.pamdas.org/"
        resources:
          requests:
            memory: "700Mi"
            cpu: "600m"
          limits:
            memory: "700Mi"
            cpu: "600m"
        ports:
        - containerPort: 80
